{"version":3,"file":"index.min.js","sources":["../src/index.js"],"sourcesContent":["import React from \"react\";\nimport { BehaviorSubject, pipe, Subject, isObservable, of } from \"rxjs\";\nimport { map, takeUntil, mergeAll } from \"rxjs/operators\";\n\nfunction internalizeKey(key) {\n  return function (val) {\n    return { [key]: val };\n  };\n}\n\nfunction forEachKey(obj, callback) {\n  var keys = Object.keys(obj);\n  for (var i = 0; i < keys.length; i++) {\n    callback(obj[keys[i]], keys[i]);\n  }\n}\n\nfunction getStreams(obj) {\n  const streams = [];\n\n  forEachKey(obj, function (val, key) {\n    if (isObservable(val)) {\n      streams.push(val.pipe(map(internalizeKey(key))));\n    }\n  });\n\n  return streams;\n}\n\nfunction isShallowEqual(v, o) {\n  var k1 = Object.keys(v);\n  var k2 = Object.keys(o);\n  if (k1.length !== k2.length) {\n    return false;\n  }\n  for (var i = 0; i < k1.length; i++) {\n    if (o[k1[i]] !== v[k2[i]]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction mergeObjTo(ob1, ob2) {\n  var result = {};\n  forEachKey(ob1, function (val, key) {\n    result[key] = val;\n  });\n  forEachKey(ob2, function (val, key) {\n    result[key] = val;\n  });\n  return result;\n}\n\nfunction xstream(controller, Wrapped) {\n  function StreamC() {\n    var self = this;\n    this.props$ = new BehaviorSubject(mergeObjTo({}, arguments[0]));\n    this.force$ = new Subject();\n    this.destroyed$ = new Subject();\n    this.streams = [];\n    this.resolved = {};\n\n    var intercept = pipe();\n\n    controller({\n      props$: self.props$,\n      destroyed$: self.destroyed$,\n      resolve: function (strObj) {\n        self.resolved = mergeObjTo({}, strObj);\n        self.streams = getStreams(strObj || {});\n      },\n      setIntercept: function (i) {\n        intercept = i;\n      },\n    });\n\n    var resolvedStreams = of.apply(null, self.streams).pipe(\n      mergeAll(),\n      map(function (obj) {\n        self.resolved = mergeObjTo(self.resolved, obj);\n      })\n    );\n\n    of(self.props$, resolvedStreams)\n      .pipe(mergeAll(), takeUntil(self.destroyed$), intercept)\n      .subscribe(\n        function () {\n          self.force$.next();\n        },\n        function (e) {\n          console.error(e);\n        }\n      );\n\n    React.Component.apply(self, arguments);\n  }\n\n  StreamC.prototype = Object.create(React.Component.prototype);\n\n  var sProto = StreamC.prototype;\n\n  sProto.constructor = StreamC;\n\n  sProto.componentDidMount = function () {\n    var self = this;\n    self.force$.pipe(takeUntil(self.destroyed$)).subscribe(function () {\n      self.forceUpdate();\n    });\n  };\n\n  sProto.componentWillUnmount = function () {\n    this.destroyed$.next();\n  };\n\n  sProto.shouldComponentUpdate = function (nextProps) {\n    if (!isShallowEqual(this.props, nextProps)) {\n      this.props$.next(mergeObjTo(nextProps, {}));\n    }\n    return false;\n  };\n\n  sProto.render = function () {\n    var props = mergeObjTo(this.props$.value, this.resolved);\n    return React.createElement(Wrapped, props);\n  };\n\n  return StreamC;\n}\n\nexport default xstream;\n"],"names":["forEachKey","obj","callback","keys","Object","i","length","getStreams","streams","val","key","isObservable","push","pipe","map","mergeObjTo","ob1","ob2","result","controller","Wrapped","StreamC","self","this","props$","BehaviorSubject","arguments","force$","Subject","destroyed$","resolved","intercept","resolve","strObj","setIntercept","resolvedStreams","of","apply","mergeAll","takeUntil","subscribe","next","e","console","error","React","Component","sProto","prototype","create","constructor","componentDidMount","forceUpdate","componentWillUnmount","shouldComponentUpdate","nextProps","v","o","k1","k2","isShallowEqual","props","render","value","createElement"],"mappings":"qKAUA,SAASA,EAAWC,EAAKC,GAEvB,IADA,IAAIC,EAAOC,OAAOD,KAAKF,GACdI,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAC/BH,EAASD,EAAIE,EAAKE,IAAKF,EAAKE,IAIhC,SAASE,EAAWN,GAClB,MAAMO,EAAU,GAQhB,OANAR,EAAWC,EAAK,SAAUQ,EAAKC,GAhBjC,IAAwBA,EAiBhBC,eAAaF,IACfD,EAAQI,KAAKH,EAAII,KAAKC,OAlBJJ,EAkBuBA,EAjBtC,SAAUD,GACf,MAAO,EAAGC,GAAMD,UAoBXD,EAiBT,SAASO,EAAWC,EAAKC,GACvB,IAAIC,EAAS,GAOb,OANAlB,EAAWgB,EAAK,SAAUP,EAAKC,GAC7BQ,EAAOR,GAAOD,IAEhBT,EAAWiB,EAAK,SAAUR,EAAKC,GAC7BQ,EAAOR,GAAOD,IAETS,YAGT,SAAiBC,EAAYC,GAC3B,SAASC,IACP,IAAIC,EAAOC,KACXA,KAAKC,OAAS,IAAIC,kBAAgBV,EAAW,GAAIW,UAAU,KAC3DH,KAAKI,OAAS,IAAIC,UAClBL,KAAKM,WAAa,IAAID,UACtBL,KAAKf,QAAU,GACfe,KAAKO,SAAW,GAEhB,IAAIC,EAAYlB,SAEhBM,EAAW,CACTK,OAAQF,EAAKE,OACbK,WAAYP,EAAKO,WACjBG,QAAS,SAAUC,GACjBX,EAAKQ,SAAWf,EAAW,GAAIkB,GAC/BX,EAAKd,QAAUD,EAAW0B,GAAU,KAEtCC,aAAc,SAAU7B,GACtB0B,EAAY1B,KAIhB,IAAI8B,EAAkBC,KAAGC,MAAM,KAAMf,EAAKd,SAASK,KACjDyB,aACAxB,MAAI,SAAUb,GACZqB,EAAKQ,SAAWf,EAAWO,EAAKQ,SAAU7B,MAI9CmC,KAAGd,EAAKE,OAAQW,GACbtB,KAAKyB,aAAYC,YAAUjB,EAAKO,YAAaE,GAC7CS,UACC,WACElB,EAAKK,OAAOc,QAEd,SAAUC,GACRC,QAAQC,MAAMF,KAIpBG,UAAMC,UAAUT,MAAMf,EAAMI,WAK9B,IAAIqB,EAFJ1B,EAAQ2B,UAAY5C,OAAO6C,OAAOJ,UAAMC,UAAUE,WA6BlD,OAzBAD,EAAOG,YAAc7B,EAErB0B,EAAOI,kBAAoB,WACzB,IAAI7B,EAAOC,KACXD,EAAKK,OAAOd,KAAK0B,YAAUjB,EAAKO,aAAaW,UAAU,WACrDlB,EAAK8B,iBAITL,EAAOM,qBAAuB,WAC5B9B,KAAKM,WAAWY,QAGlBM,EAAOO,sBAAwB,SAAUC,GAIvC,OA1FJ,SAAwBC,EAAGC,GACzB,IAAIC,EAAKtD,OAAOD,KAAKqD,GACjBG,EAAKvD,OAAOD,KAAKsD,GACrB,GAAIC,EAAGpD,SAAWqD,EAAGrD,OAArB,CAGA,IAAK,IAAID,EAAI,EAAGA,EAAIqD,EAAGpD,OAAQD,IAC7B,GAAIoD,EAAEC,EAAGrD,MAAQmD,EAAEG,EAAGtD,IACpB,OAGJ,OAAO,GA4EAuD,CAAerC,KAAKsC,MAAON,IAC9BhC,KAAKC,OAAOiB,KAAK1B,EAAWwC,EAAW,MAElC,GAGTR,EAAOe,OAAS,WACd,IAAID,EAAQ9C,EAAWQ,KAAKC,OAAOuC,MAAOxC,KAAKO,UAC/C,OAAOe,UAAMmB,cAAc5C,EAASyC,IAG/BxC"}